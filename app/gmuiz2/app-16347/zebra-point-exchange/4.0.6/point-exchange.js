define("mui/zebra-point-exchange/point-exchange",function(t,i,n){var e=Object.assign||function(t){for(var i=1;i<arguments.length;i++){var n=arguments[i];for(var e in n){if(Object.prototype.hasOwnProperty.call(n,e)){t[e]=n[e]}}}return t};function o(t){if(Array.isArray(t)){for(var i=0,n=Array(t.length);i<t.length;i++){n[i]=t[i]}return n}else{return Array.from(t)}}var a=t("mui/zepto/zepto");var r=t("mui/hybrid/index");var s=t("mui/datalazyload/index");var l=t("./dialog");t("mui/mtop/index");t("hybrid/plugin/pageVisibility");var c=a(window);var h="viewItem";var d='<div class="no-results">\u6ca1\u6709\u627e\u5230\u76f8\u5173\u7684\u5546\u54c1</div>';r.regProxy("mtop",function(t){if(location.href.indexOf("env=pre")>0){if(window.lib&&window.lib.mtop){window.lib.mtop.config.subDomain="wapa"}}return t});function u(t,i){var n=this;var e=i.tabs;var o=i.cfg;var r=i.listRender;var c=i.dialogLink;var d=i.env;this.$el=a(t);this.$container=this.$el.find(".J_point-tab-container");this.$tabs=e;this.listRender=r;this.dialogLink=c;this.env=d;this.loader=s(this.$container,{diff:100,autoDestroy:false});this.dialog=new l({content:"\u62b1\u6b49\uff0c\u60a8\u7684\u79ef\u5206\u4e0d\u8db3\u4ee5\u5151\u6362\u6b64\u5546\u54c1",buttons:[{text:"\u53bb\u8d5a\u79ef\u5206",link:this.dialogLink,fn:function u(){return n.dialog.hide()}},{id:h,text:"\u67e5\u770b\u5546\u54c1",fn:function v(){return n.dialog.hide()}}]});this.config=f(o);this.cache={};this.pending=false;this.appId=2144;this.pageSize=20;this.totalPage=10;this.totalCount=this.pageSize*this.totalPage;this.availablePoints=0;this.isLogin=false;this.bindEvents();this.init()}a.extend(u.prototype,{init:function w(){var t=this.$tabs.curIndex;this.$tabs.trigger("switch",{curIndex:t,curTarget:this.$tabs.$items.eq(t)});this.updatePoints();this.checkLogin();this.goldlog({action:"init"})},updatePoints:function $(){var t=this;m(function(i,n){if(!i){t.availablePoints=Number(n)||0}})},checkLogin:function k(){var t=this;r.isLogin(function(i){var n=i.isLogin;return t.isLogin=n})},bindEvents:function z(){this.$tabs.on("switch",a.proxy(this.onSwitch,this));this.$el.on("click",".point-item",a.proxy(this.onItemClick,this));c.on("scroll",a.proxy(this.onScroll,this));if(r.isTmall||r.isTaobao){r.plugin.pageVisibility.watch(a.proxy(this.onPageVisibilityChange,this))}},fetchData:function L(t){var i=this;var n=this.appId;var e=this.categoryId;var o=this.pageSize;var a=this.totalCount;var s=this.cache;var l={appId:n,pageSize:o,pageNo:s[e].current,floorId:e,count:a};this.pending=true;r.mtop({api:"mtop.lotus.point.exchange.query",v:"1.0",ecode:0,sessionOption:"AutoLoginOnly",data:l},function(n){i.pending=false;if(n.errorCode===0){t(null,n.data.model.items)}else{t(new Error("mtop \u8bf7\u6c42\u63a5\u53e3\u51fa\u9519"))}})},loadNew:function I(t){var i=this.cache;var n=this.categoryId;function e(t){i[n].items=i[n].items.concat(t);i[n].current++;return t}this.fetchData(function(i,n){if(i){return t(i)}t(null,e(n))})},getContents:function P(t){var i=this.cache;var n=this.categoryId;var e=this.currentTab;if(i[n]){return t(null,i[n].items)}i[n]={current:0,items:[].concat(o(e.items||[]))};this.loadNew(function(e){if(e){return t(e,i[n].items)}t(null,i[n].items)})},render:function T(t){return this.listRender(t)},resetPosition:function C(){var t=this.$el.offset();var i=t.top;if(c.scrollTop()>=i){c.scrollTop(i)}},hasMore:function X(){var t=this.cache;var i=this.categoryId;return t[i].current<this.totalPage},handleError:function j(){var t=this.$container.find(".error");var i="\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5";if(!t.length){this.$container.append('<div class="error">'+i+"</div>")}else{t.text(i)}},onItemClick:function O(t){var i=a(t.currentTarget);var n=i.attr("href");var e=Number(i.attr("data-point"));var o=i.attr("data-itemid");this.goldlog({action:"click",itemid:o});if(!this.isLogin||e>this.availablePoints){t.preventDefault();if(!this.isLogin){g(b(n),function(t){if(t)return;p(i)});return false}if(e>this.availablePoints){this.dialog.getButton(h).setLink(n);this.dialog.show();return false}}},onPageVisibilityChange:function R(t){var i=t.visible;if(i){this.updatePoints();this.checkLogin()}},onSwitch:function E(t){var i=this;var n=t.curTarget;this.categoryId=n.attr("data-id");this.currentTab=v(this.config.moduleTabs,function(t){return t.id===Number(i.categoryId)})[0];this.getContents(function(t,n){var e=d;if(n.length){e=i.render(n)}i.$container.html(e);i.loader.addElements("img[data-ks-lazyload]");if(t){i.handleError()}i.goldlog({action:"tab_switch"})});this.resetPosition()},onScroll:function _(){var t=this;var i=300;var n=this.$container.offset().top;var e=this.$container.height();var o=c.scrollTop()+c.height();if(o>=e+n-i){if(!this.pending&&this.hasMore()){this.loadNew(function(i,n){if(i){return t.handleError()}var e=a(t.render(n));t.$container.find(".error").remove();t.$container.append(e);t.loader.addElements("img[data-ks-lazyload]")})}}},goldlog:function N(t){var i=e({device:this.env,tabid:this.categoryId},t);var n=[];for(var o in i){if(i.hasOwnProperty(o)){n.push(o+"="+i[o])}}if(window.goldlog){window.goldlog.record("/tmwap.20160712.2","",n.join("&"),"H46926360")}}});function f(t){try{return JSON.parse(t)}catch(i){return{}}}function v(t,i){if(t.filter)return t.filter(i);var n=[];for(var e=0;e<t.length;e++){var o=t[e];if(i(o)===true){n.push(o)}}return n}function p(t){var i=a(t).attr("href");r.pushWindow(i)}function g(t,i){if(r.isWeb){location.href="//login.tmall.com?redirectURL="+encodeURIComponent(t)}else{r.login(function(t){var n=t.errorCode;if(n===0){i(null)}else{i(new Error("login failed!"))}})}}function m(t){r.mtop({api:"mtop.lotus.available.point.query",v:"1.0",ecode:0,sessionOption:"AutoLoginOnly"},function(i){if(i.errorCode===0){t(null,i.data.model)}else{t(new Error("mtop \u63a5\u53e3\u8c03\u7528\u51fa\u9519"))}})}function b(t){return t.indexOf("//")===0?location.protocol+t:t}function y(t,i){return t.replace(/\{\{(.+?)\}\}/g,function(t,n){return i[n.trim()]||""})}function x(t){var i=r.isTaobao||r.isTmall?"400x400q75.jpg":"200x200.jpg";var n=""+'<a href="{{itemUrl}}" class="point-item" data-itemid="{{itemId}}" data-point="{{pointFee}}" target="_blank">'+'<div class="point-item-img">'+'<img src="//img.alicdn.com/tps/i3/TB1o6LyJXXXXXaTXXXX07tlTXXX-200-200.png" data-ks-lazyload="{{imageUrl}}_'+i+'"/>'+"</div>"+'<div class="point-item-title">{{title}}</div>'+'<div class="point-item-meta">'+'<i class="point-item-icon"></i>'+'<span class="point-item-count"><em>{{pointFee}}</em>\u79ef\u5206</span>'+'<del class="point-item-price">&yen;{{originalPrice}}</del>'+"</div>"+"</a>";return y(n,t)}u.itemRender=x;n.exports=u});