define("mui/chaoshi-ald/index",["mui/mtop/index","mui/custom-event/index","mui/chaoshi-app/site-info","mui/zebra-dynamic/ald-bottom"],function(e,a,t){"use strict";function r(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}var n=function(){function e(e,a){for(var t=0;t<a.length;t++){var r=a[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(a,t,r){return t&&e(a.prototype,t),r&&e(a,r),a}}(),i=e("mui/mtop/index"),o=e("mui/custom-event/index"),s=e("mui/chaoshi-app/site-info"),c=e("mui/zebra-dynamic/ald-bottom"),u="mtop.taobao.aladdin.service.AldRecommendService.chaoshi.recommend",l=u+"2",f=function(e){window.tes_queue||(window.tes_queue=[]);var a=Object.assign({sampling:.01,type:"fetch",msg:"\u63a5\u53e3\u8fd4\u56de\u7684\u6570\u636e\u5f02\u5e38"},e);tes_queue.push(a)},g=function(){function a(e,t,n){r(this,a),this.mtopConfig=Object.assign({v:"1.0",ecode:0},e),this.config=Object.assign({parse:function(e){return e.data.resultValue},validate:function(e){return 0===e.retType}},t),this.fallbackConfig=Object.assign({useFallback:!0,backupParams:{}},n)}return n(a,[{key:"request",value:function(){var e=this;return e.trigger("beforeSend",{}),new Promise(function(a,t){s.request().then(function(r){var n=e.mtopConfig.data.appId.indexOf(",")===-1?u:l,o=Object.assign({api:n},e.mtopConfig);o.data=Object.assign({smAreaId:r.cityId,logica:r.logica},o.data),e.fallbackConfig.useFallback&&!function(){var a=Object.assign(e.fallbackConfig.backupParams,{smAreaId:r.cityId}),t={};Object.keys(a).forEach(function(e,r){o.data[e]&&(t[e]=a[e])}),o.data=Object.assign(o.data,{isbackup:!0,backupParams:Object.keys(t).sort().join(",")}),e.fallbackConfig.backupParams=t}(),e.mtopConfig=Object.assign({},o),i.request(o).then(function(r){if(e.config.validate(r)){var n=e.config.parse(r),i={data:n,res:r,from:0};a(i),e.trigger("success",i),e.trigger("complete",i)}else if(f({msg:"mtop\u63a5\u53e3\u8bf7\u6c42\u6210\u529f\uff0c\u8fd4\u56de\u7684\u6570\u636e\u4e0d\u7b26\u5408\u524d\u7aef\u9884\u671f",api:e.mtopConfig.api,useFallback:e.fallbackConfig.useFallback,params:e.mtopConfig.data,responseData:r}),e.fallbackConfig.useFallback)e.requestFallback(r).then(a,t);else{var o={errCode:900,res:r,from:0};t(o),e.trigger("error",o),e.trigger("complete",o)}},function(r){if(e.fallbackConfig.useFallback)e.requestFallback(r).then(a,t);else{var n={errCode:901,res:r,from:0};t(n),e.trigger("error",n),e.trigger("complete",n)}})})})}},{key:"genFallbackConfig",value:function(e){var a=this,t={appId:a.mtopConfig.data.appId,backupParams:a.fallbackConfig.backupParams},r=c.createBottomCallback(t);c.getBottomUrl(t).then(function(a){e({url:a,params:{callback:r}})})}},{key:"requestFallback",value:function(a){var t=this;return new Promise(function(r,n){t.genFallbackConfig(function(i){e(["mui/fetch/jsonp"],function(e){e(i.url,Object.assign({method:"jsonp"},i.params)).then(function(e){return e.json()}).then(function(e){var a={data:{resultValue:e},retType:0};if(t.config.validate(a)){var o=t.config.parse(a),s={data:o,res:e,from:1};r(s),t.trigger("success",s),t.trigger("complete",s)}else{var c={errCode:900,res:e,from:1};n(c),t.trigger("error",c),t.trigger("complete",c),f({msg:"cdn\u6253\u5e95\u6570\u636e\u8bf7\u6c42\u6210\u529f\uff0c\u8fd4\u56de\u7684\u6570\u636e\u4e0d\u7b26\u5408\u524d\u7aef\u9884\u671f",api:i.url,params:i.params,responseData:e})}})["catch"](function(e){var r={errCode:901,ex:e,res:a,from:1};n(r),t.trigger("error",r),t.trigger("complete",r),f({msg:"cdn\u6253\u5e95\u6570\u636e\u8bf7\u6c42\u5931\u8d25",api:i.url,params:i.params,responseData:r})})})})})}}]),a}();Object.assign(g.prototype,o),t.exports=g});