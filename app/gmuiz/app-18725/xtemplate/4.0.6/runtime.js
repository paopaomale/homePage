define("mui/xtemplate/runtime",function(e,r,n){"use strict";var t=e("./runtime/util");var a=e("./runtime/commands");var i={};var o=e("./runtime/scope");var u=e("./runtime/linked-buffer");function s(e,r,n,t,a,i,o,u){this.name=e;this.originalName=i||e;this.runtime=r;this.root=n;this.pos={line:1};this.scope=t;this.buffer=a;this.fn=o;this.parent=u}function f(e,r,n){var t=n[0];var a=e&&e[t]||r&&r[t]||i[t];if(n.length===1){return a}if(a){var o=n.length;for(var u=1;u<o;u++){a=a[n[u]];if(!a){return false}}}return a}function p(e,r){var n=e.split("/");var t=r.split("/");n.pop();for(var a=0,i=t.length;a<i;a++){var o=t[a];if(o==="."){continue}else if(o===".."){n.pop()}else{n.push(o)}}return n.join("/")}function c(e,r,n,t,a,i){var o=undefined;var u=undefined;var s=undefined;if(!i){s=f(e.runtime.commands,e.root.config.commands,a)}if(s){return s.call(e,r,n,t)}else if(s!==false){var p=a.slice(0,-1);o=r.resolve(p,i);if(o===null||o===undefined){t.error("Execute function `"+a.join(".")+"` Error: "+p.join(".")+" is undefined or null");return t}u=o[a[a.length-1]];if(u){try{return u.apply(o,n.params||[])}catch(c){t.error("Execute function `"+a.join(".")+"` Error: "+c.message);return t}}}t.error("Command Not Found: "+a.join("."));return t}var l={callFn:c,callDataFn:function w(e,r){var n=r[0];var t=n;for(var a=1;a<r.length;a++){var i=r[a];if(t&&t[i]){n=t;t=t[i]}else{return""}}return t.apply(n,e||[])},callCommand:function T(e,r,n,t,a){return c(e,r,n,t,a)}};function v(e,r){this.fn=e;this.config=t.merge(v.globalConfig,r);this.subNameResolveCache={};this.loadedSubTplNames={}}t.mix(v,{config:function E(e,r){var n=this.globalConfig=this.globalConfig||{};if(e!==undefined){if(r!==undefined){n[e]=r}else{t.mix(n,e)}}else{return n}},nativeCommands:a,utils:l,util:t,addCommand:function C(e,r){i[e]=r},removeCommand:function P(e){delete i[e]}});function d(e,r,n){var t=r;if(t.charAt(0)!=="."){return t}var a=n+"_ks_"+t;var i=e.subNameResolveCache;var o=i[a];if(o){return o}t=i[a]=p(n,t);return t}function m(e,r,n,t,a,i,o,u){var f=new s(r,n,e,t,a,i,undefined,u);a.tpl=f;e.config.loader.load(f,function(e,r){var n=r;if(typeof n==="function"){f.fn=n;y(f)}else if(e){a.error(e)}else{n=n||"";if(o){a.writeEscaped(n)}else{a.data+=n}a.end()}})}function h(e,r,n,t,a,i){var o=d(e,i,a.name);var u=t.insert();var s=u.next;m(e,o,a.runtime,r,u,i,n,t.tpl);return s}function x(e,r,n,t,a){var i=n.insert();var o=i.next;var u=new s(a.TPL_NAME,t.runtime,e,r,i,undefined,a,n.tpl);i.tpl=u;y(u);return o}function y(e){var r=e.fn();if(r){var n=e.runtime;var t=n.extendTpl;var a=undefined;if(t){a=t.params[0];if(!a){return r.error("extend command required a non-empty parameter")}}var i=n.extendTplFn;var o=n.extendTplBuffer;if(i){n.extendTpl=null;n.extendTplBuffer=null;n.extendTplFn=null;x(e.root,e.scope,o,e,i).end()}else if(a){n.extendTpl=null;n.extendTplBuffer=null;h(e.root,e.scope,0,o,e,a).end()}return r.end()}}function g(e,r,n){var a=r.params;if(!a[0]){return n.error("include command required a non-empty parameter")}var i=e;var u=a[1];var s=r.hash;if(s){if(u){u=t.mix({},u)}else{u={}}t.mix(u,s)}if(u){i=new o(u,undefined,e)}return i}function b(e,r,n){var t=r.params[0];var a=d(e,t,n.name);var i=e.loadedSubTplNames;if(i[a]){return false}i[a]=true;return true}v.prototype={constructor:v,Scope:o,nativeCommands:a,utils:l,removeCommand:function j(e){var r=this.config;if(r.commands){delete r.commands[e]}},addCommand:function S(e,r){var n=this.config;n.commands=n.commands||{};n.commands[e]=r},include:function R(e,r,n,t){return h(this,g(e,r,n),r.escape,n,t,r.params[0])},includeModule:function N(e,r,n,t){return x(this,g(e,r,n),n,t,r.params[0])},includeOnce:function k(e,r,n,t){if(b(this,r,t)){return this.include(e,r,n,t)}return n},includeOnceModule:function A(e,r,n,t){if(b(this,r,t)){return this.includeModule(e,r,n,t)}return n},render:function B(e,r,n){var t=this;var a=r;var i=n;var u="";var f=this.fn;var p=this.config;if(typeof a==="function"){i=a;a=null}a=a||{};if(!i){i=function(e,r){var n=e;if(n){if(!(n instanceof Error)){n=new Error(n)}throw n}u=r}}var c=this.config.name;if(!c&&f&&f.TPL_NAME){c=f.TPL_NAME}var l=undefined;if(e instanceof o){l=e}else{l=new o(e)}var d=new v.LinkedBuffer(i,p).head;var m=new s(c,{commands:a.commands},this,l,d,c,f);d.tpl=m;if(!f){p.loader.load(m,function(e,r){if(r){m.fn=t.fn=r;y(m)}else if(e){d.error(e)}});return u}y(m);return u}};v.Scope=o;v.LinkedBuffer=u;n.exports=v});