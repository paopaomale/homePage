define("mui/zebra-dynamic/request",["mui/zebra-dynamic/io","mui/zepto/touch","mui/zebra-dynamic/ald-bottom"],function(t,e,a){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var n=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),i=t("mui/zebra-dynamic/io"),o=t("mui/zepto/touch"),c=t("mui/zebra-dynamic/ald-bottom"),u={timeout:8e3,duplication:!1,mtop:!1,params:{},closeBackup:!1},s=c,f=(new Date).getTime();window.__pvuuid?f=window.__pvuuid:window.__pvuuid=f;var m=/^(https?:|)\/\/(.*)data\.jsonp$/i,p=function(t){return"[object Object]"===Object.prototype.toString.call(t)},l=function(t){return"[object String]"===Object.prototype.toString.call(t)},h=function(t){return t&&l(t)&&m.test(t)},d=function(t){var e=[];return t.forEach(function(t){o.inArray(t,e)===-1&&e.push(t)}),e},k=function(){function t(e){var a=this;if(r(this,t),codeTrack("request.init","dynamic.parse"),this.cfg=Object.assign({},u,e),this.cfg.params=this.cfg.params||{},this.cfg.backupParams=this.cfg.backupParams||{},this.cfg.forceBackupHasParam===!0&&!this.cfg.closeBackup){var n=[];Object.keys(this.cfg.backupParams).forEach(function(t){a.cfg.params[t]?n.push(t):delete a.cfg.backupParams[t]}),this.cfg.params.isbackup=!0,this.cfg.params.backupParams=n.join(",")}this.isV3Config=!1,this.requestStack={},this.backUpDataList={},this.resultDataList={}}return n(t,[{key:"push",value:function(t){var e=t.__data_url,a=t.__data_param&&t.__data_param.appId;if(a)switch(this.checkBottomConfigVersion(t.__data_default)){case"v3":this.isV3Config||(this.isV3Config=!0);break;case"v2":this.backUpDataList[a]={url:t.__data_default.url,length:t.__data_default.length};break;case"v1":default:this.backUpDataList[a]=t.__data_default}this.requestStack[e]?(this.requestStack[e].dataParam=this._mergeParams(this.requestStack[e].dataParam,t.__data_param),this.requestStack[e].dataBackupParam=this._mergeParams(this.requestStack[e].dataBackupParam,t.__data_backup_param||{}),this.requestStack[e].dataDetection=this._mergeArray(this.requestStack[e].dataDetection,t.__data_detection)):this.requestStack[e]={dataParam:t.__data_param,dataType:this._getDataType(t.__data_type),dataDetection:t.__data_detection||[]},this.cfg.duplication||(this.requestStack[e].dataParam._pvuuid=f)}},{key:"checkBottomConfigVersion",value:function(t){return p(t)&&t.url&&h(t.url)?"v2":p(t)&&!t.url&&t.length?"v3":"v1"}},{key:"_mergeParams",value:function(t,e){for(var a in t)t[a]&&e[a]&&t[a].indexOf(e[a])<0&&(t[a]+=","+e[a]);return Object.assign(e,t)}},{key:"_mergeArray",value:function(t,e){return e&&e.forEach(function(e){o.inArray(e,t)||t.push(e)}),t}},{key:"_getDataType",value:function(t){var e=void 0;switch(t){case"json":e="json";break;case"jsonp":e="jsonp";break;default:e="jsonp"}return e}},{key:"_mergeData",value:function(t,e){var a=this,r="string"==typeof t?d(t.split(",")):[t];codeTrack("merge.init","request.fetch");var n=r.map(function(t){return a._connectTagData(t,e&&e[t]&&e[t].data,a.backUpDataList[t],e&&e[t]&&e[t].exposureParam,e&&e[t]&&e[t].success)});return new Promise(function(t,e){Promise.all(n).then(function(e){r.forEach(function(t,r){a.resultDataList[t]=e[r]}),t(a.resultDataList)})["catch"](function(t){e(t)})})}},{key:"_connectTagData",value:function(t,e,a,r,n){var i=this;return new Promise(function(r,o){var c=window.Dynamic_NotEmptyData&&e&&e.length<1;""+n!="true"&&(c=!0),e&&!c?r(e):(codeTrack("error:merge.empty","merge.init",{msg:"\u4eba\u7fa4\u4e2a\u6027\u5316\uff0c\u6570\u636e\u4e3a\u7a7a\uff0c\u53d6\u6253\u5e95\u6570\u636e"}),i._dataBack(a,t).then(r))})}},{key:"_isCDNBack",value:function(t){return p(t)&&t.url&&t.length}},{key:"_dataBack",value:function(t,e){return this.isV3Config||this.cfg.forceBackupHasParam?s.getBottom({appId:e,backupParams:this.cfg.backupParams}).then(function(t){return s.mergeData([e],t,!0)}).then(function(t){return Promise.resolve(t[e])})["catch"](function(t){codeTrack("error:v3.error","request.fetch",{msg:t.message+"\n"+t.stack})}):this._isCDNBack(t)?i("http",{url:t.url,dataType:"jsonp",params:{},timeout:2e3,callback:"callback_"+e.replace(/-/g,"_")}).then(function(t){return Promise.resolve(t.data)})["catch"](function(e){Promise.resolve(t)}):Promise.resolve(t)}},{key:"reset",value:function(){this.isV3Config=!1,this.requestStack={},this.backUpDataList={},this.resultDataList={}}},{key:"run",value:function(){var t=this,e=this.requestStack,a=Object.assign({},t.cfg);return new Promise(function(r,n){o.each(e,function(e,c){var u=Object.assign(a.params,c.dataParam),f=Object.assign(a.backupParams,c.dataBackupParam),m=u.appId,p="string"==typeof m?d(m.split(",")):[m];codeTrack("request.fetch","request.detector"),i(a.mtop?"mtop":"http",{url:e,dataType:c.dataType,params:u,api:a.mtopApiName,timeout:a.timeout}).then(function(a){codeTrack("io.success","request.fetch"),t._mergeData(m,a).then(function(a){delete t.requestStack[e],o.isEmptyObject(t.requestStack)&&(r(a),t.reset())})["catch"](function(t){throw t})})["catch"](function(i){return codeTrack("error:io.error","request.fetch",{msg:i.message+"\n"+i.stack}),a.closeBackup?(n(i),void t.reset()):void(t.isV3Config||a.forceBackupHasParam?s.getBottom({appId:m,backupParams:f}).then(function(t){return s.mergeData(p,t,!0)}).then(function(a){Object.assign(t.resultDataList,a),delete t.requestStack[e],o.isEmptyObject(t.requestStack)&&(r(t.resultDataList),t.reset())})["catch"](function(t){codeTrack("error:v3.error","request.fetch",{msg:t.message+"\n"+t.stack})}):t._mergeData(m,void 0,!0).then(function(a){delete t.requestStack[e],o.isEmptyObject(t.requestStack)&&(r(a),t.reset())})["catch"](function(t){codeTrack("error:merge.error","request.fetch",{msg:t.message+"\n"+t.stack})}))})})})}}]),t}();a.exports=k});