define("mui/zebra-dynamic/request",function(t,e,r){"use strict";var a=function(){function t(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(t,a.key,a)}}return function(e,r,a){if(r)t(e.prototype,r);if(a)t(e,a);return e}}();function n(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}var i=t("mui/zebra-dynamic/io"),o=t("mui/zebra-dynamic/detector"),c=t("mui/zepto/touch"),u=t("mui/zebra-dynamic/ald-bottom"),s={timeout:8e3,duplication:false,mtop:false,params:{}};var f=new u,l=(new Date).getTime();if(window.__pvuuid){l=window.__pvuuid}else{window.__pvuuid=l}var d=/^(https?:|)\/\/(.*)data\.jsonp$/i;var m=function g(t){return Object.prototype.toString.call(t)==="[object Object]"};var h=function k(t){return Object.prototype.toString.call(t)==="[object String]"};var p=function _(t){return t&&h(t)&&d.test(t)};var y=function b(t){var e=[];t.forEach(function(t){if(c.inArray(t,e)===-1)e.push(t)});return e};var v=function(){function t(e){n(this,t);codeTrack("request.init","dynamic.parse");this.cfg=Object.assign(s,e);this.isV3Config=false;this.requestStack={};this.backUpDataList={};this.resultDataList={}}a(t,[{key:"push",value:function e(t){var e=t.__data_url,r=t.__data_param&&t.__data_param.appId;if(r){switch(this.checkBottomConfigVersion(t.__data_default)){case"v3":if(!this.isV3Config){this.isV3Config=true}break;case"v2":this.backUpDataList[r]={url:t.__data_default.url,length:t.__data_default.length};break;case"v1":default:this.backUpDataList[r]=t.__data_default;break}}if(this.requestStack[e]){this.requestStack[e].dataParam=this._mergeParams(this.requestStack[e].dataParam,t.__data_param);this.requestStack[e].dataDetection=this._mergeArray(this.requestStack[e].dataDetection,t.__data_detection)}else{this.requestStack[e]={dataParam:t.__data_param,dataType:this._getDataType(t.__data_type),dataDetection:t.__data_detection||[]}}if(!this.cfg.duplication){this.requestStack[e].dataParam._pvuuid=l}}},{key:"checkBottomConfigVersion",value:function r(t){return m(t)&&t.url&&p(t.url)?"v2":m(t)&&!t.url&&t.length?"v3":"v1"}},{key:"_mergeParams",value:function u(t,e){for(var r in t){if(t[r]&&e[r]&&t[r].indexOf(e[r])<0){t[r]+=","+e[r]}}return Object.assign(e,t)}},{key:"_mergeArray",value:function d(t,e){e&&e.forEach(function(e){if(!c.inArray(e,t)){t.push(e)}});return t}},{key:"_getDataType",value:function h(t){var e=undefined;switch(t){case"json":e="json";break;case"jsonp":e="jsonp";break;default:e="jsonp";break}return e}},{key:"_mergeData",value:function v(t,e){var r=this,a=typeof t==="string"?y(t.split(",")):[t];codeTrack("merge.init","request.fetch");var n=a.map(function(t){return r._connectTagData(t,e&&e[t]&&e[t].data,r.backUpDataList[t],e&&e[t]&&e[t].exposureParam)});return new Promise(function(t,e){Promise.all(n).then(function(e){a.forEach(function(t,a){r.resultDataList[t]=e[a]});t(r.resultDataList)})["catch"](function(t){e(t)})})}},{key:"_connectTagData",value:function g(t,e,r,a){var n=this;return new Promise(function(a,i){if(e){a(e)}else{codeTrack("error:merge.empty","merge.init",{msg:"\u4eba\u7fa4\u4e2a\u6027\u5316\uff0c\u6570\u636e\u4e3a\u7a7a\uff0c\u53d6\u6253\u5e95\u6570\u636e"});n._dataBack(r,t).then(a)}})}},{key:"_isCDNBack",value:function k(t){return m(t)&&t.url&&t.length}},{key:"_dataBack",value:function _(t,e){return this._isCDNBack(t)?i("http",{url:t.url,dataType:"jsonp",params:{},timeout:2e3,callback:"callback_"+e.replace(/-/g,"_")}).then(function(t){return Promise.resolve(t.data)})["catch"](function(e){Promise.resolve(t)}):Promise.resolve(t)}},{key:"reset",value:function b(){this.isV3Config=false;this.requestStack={};this.backUpDataList={};this.resultDataList={}}},{key:"run",value:function T(){var t=this;var e=this.requestStack;var r=Object.assign({},t.cfg);return new Promise(function(a,n){c.each(e,function(e,u){codeTrack("request.detector","request.init");o(u.dataDetection).then(function(n){var o=Object.assign(t.cfg.params,u.dataParam,n),s=u.dataParam.appId,l=typeof s==="string"?y(s.split(",")):[s];codeTrack("request.fetch","request.detector");i(r.mtop?"mtop":"http",{url:e,dataType:u.dataType,params:o,timeout:r.timeout}).then(function(r){codeTrack("io.success","request.fetch");t.isV3Config?f.saveBottomUrl(s,r.__bottomUrl__).then(function(t){return f.mergeData(l,r)}).then(function(r){Object.assign(t.resultDataList,r);delete t.requestStack[e];if(c.isEmptyObject(t.requestStack)){a(t.resultDataList);t.reset()}})["catch"](function(t){throw t}):t._mergeData(s,r).then(function(r){delete t.requestStack[e];if(c.isEmptyObject(t.requestStack)){a(r);t.reset()}})["catch"](function(t){throw t})})["catch"](function(r){codeTrack("error:io.error","request.fetch",{msg:r.message+"\n"+r.stack});t.isV3Config?f.getBottom(s).then(function(t){return f.mergeData(l,t)}).then(function(r){Object.assign(t.resultDataList,r);delete t.requestStack[e];if(c.isEmptyObject(t.requestStack)){a(t.resultDataList);t.reset()}})["catch"](function(t){codeTrack("error:v3.error","request.fetch",{msg:t.message+"\n"+t.stack})}):t._mergeData(s).then(function(r){delete t.requestStack[e];if(c.isEmptyObject(t.requestStack)){a(r);t.reset()}})["catch"](function(t){codeTrack("error:merge.error","request.fetch",{msg:t.message+"\n"+t.stack})})})})["catch"](n)})})}}]);return t}();r.exports=v});